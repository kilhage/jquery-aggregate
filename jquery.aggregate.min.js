/*--------------------------------------------*
 * https://github.com/kilhage/jquery-aggregate
 *--------------------------------------------*
 * Author Emil Kilhage
 * MIT Licensed
 *--------------------------------------------*
 * Last Update: 2011-04-27 00:31:39
 * Version x
 *--------------------------------------------*/
(function(d,j,t){var l=["target","source"],n={},o={},m=j.String,u=j.parseInt,p=j.parseFloat,v=j.Array.prototype.slice,k={aggregate:function(){return this.trigger("aggregate")},remove:function(){var a=arguments;return this.each(function(){var b=d.aggregator.get(this);d.aggregator.isHandler(b)&&b.destroy.apply(b,a)})},get:function(){var a=this[0],b=false;if(a){a=d.aggregator.get(a);if(d.aggregator.isHandler(a))b=a.get.apply(a,arguments)}return b}};k.destroy=k.remove;d.fn.aggregate=function(a,b,c){var e=
typeof a,f={},g=arguments;if(!a)return this.trigger("aggregate");if(e=="string"&&d.type(k[a])=="function")return k[a].apply(this,v.call(g,1));if(e==="function")return this.bind("aggregate",a);if(e=="string"||a.nodeType||a.jquery){f.target=a;if(typeof oarser=="function")this.bind("aggregate",b);else if(b)f.parser=b;if(c)f.method=c}else if(e=="object")f=a;return new d.aggregator(this,f)};d.aggregator=function(a,b){var c=this;if(!d.aggregator.isAggregator(c))return new d.aggregator(a,b);this.aggregateCallback=
function(){c.aggregate()};c.source=d(a);b=c.options=d.aggregator.parseOptions(b);c.target=d(b.target);delete b.target;c.updateAttrs().bind();c.value=c.getAggregatedValue();c.options.start_by_aggregate===true&&c.aggregate()};d.extend(d.aggregator,{DATA_NAME:"aggregatorHandler",EVENT_NAME:"aggregate",SOURCE:"source",TARGET:"target",prototype:{_is_aggregating:false,updateAttrs:function(){return this.updateTargetAttrs().updateSourceAttrs()},bind:function(){return this._bindSource(this.source)._bind(this.target,
true)},_bind:function(a,b){a.bind("aggregate",{aggregator:this,type:b?d.aggregator.TARGET:d.aggregator.SOURCE},this.aggregateCallback);return this},_bindSource:function(a){a.bind(this.options.onEvent,this.aggregateCallback);this._bind(a);return this},unbind:function(){this._unbind(this.source,true);this.target.unbind("aggregate",this.aggregateCallback);return this},_unbind:function(a,b){a=d(a);a.unbind(this.options.onEvent,this.aggregateCallback);b&&a.unbind("aggregate",this.aggregateCallback);return this},
remove:function(a){var b=this;a=d(a);var c=a[0];b.source=b.source.filter(function(e,f){var g=f==c;g&&b.removeFromHandler(f);return!g});return b._unbind(a).updateAttrs()},destroy:function(){var a=this;d.each(l,function(b,c){a[c]=a[c].filter(function(e,f){a.removeFromHandler(f,c);return false})});return this},removeFromHandler:function(a,b){var c=d.aggregator.get(a);d.aggregator.isHandler(c)||d.error("$.aggregator::removeFromHandler: element is not bound to a aggregator-handler");c.remove(this,b);return this},
aggregate:function(){var a=this;if(a._is_aggregating==false){var b=this.getAggregatedValue();if(a.options.tostring===true)b=m(b);if(b!==a.value||!b){a.value=b;a._is_aggregating=true;a.source.trigger("aggregate",[a,"source"]);a.target.each(function(c,e){if(e[a.target_attrs[c]]!==b){e[a.target_attrs[c]]=b;d(this).trigger("change")}}).trigger("aggregate",[a,"target"]);a._is_aggregating=false}}return a},getAggregatedValue:function(){var a=this,b=a.options,c=[];a.source.each(function(f,g){var h=b.parser.call(a,
g[a.source_attrs[f]],this);if(b.fix_NaN===true&&h!=h)h=b.value_if_NaN;c.push(h)});var e=c.length>0?b.method.call(c,this):b.empty_value;return b.converter?b.converter.call(this,e):e}},options:{onEvent:"change keyup",method:"sum",parser:"int",fix_NaN:true,value_if_NaN:0,empty_value:0,tostring:true,sep:",",dec:".",group:3,start_by_aggregate:true},isAggregator:function(a){return a instanceof d.aggregator},isHandler:function(a){return a instanceof d.aggregator.handler},addMethod:function(a,b){!a||d.type(b)!=
"function"||(q[a]=b)},addParser:function(a,b){!a||d.type(b)!="function"||(r[a]=b)},get:function(a){return(a=d(a).data("aggregatorHandler"))&&d.aggregator.isHandler(a)?a:t},parseOptions:function(a){var b={};if(typeof a=="string")a={target:a};d.extend(true,b,d.aggregator.options,a);if(typeof b.parser=="string"&&s[b.parser])b.converter=s[b.parser];d.each(w,function(c,e){var f;f=typeof b[c];var g;if(f=="function")f=b[c];else{if(f=="string")g=e[b[c]];g||d.error("$.aggregator:: Unable to find option "+
c);f=g}b[c]=f});return b}});d.each(["Target","Source"],function(a,b){var c=b.toLowerCase(),e="update"+b+"Attrs",f=c+"_attrs";d.aggregator.prototype["add"+b]=function(g){var h=this[c];g=d(g).filter(function(){var i=d.inArray(this,h)==-1;if(i)h[h.length++]=this;return i});c=="source"?this._bindSource(g):this._bind(g,true);return this[e]()};d.aggregator.prototype[e]=function(){var g=this;this[f]=[];this[c].each(function(h,i){g[f][h]=i?d(i).is("input,textarea")?"value":"innerHTML":null});return this}});
d.aggregator.prototype.add=d.aggregator.prototype.addSource;d.aggregator.handler=function(a){this.element=a;this.source=[];this.target=[]};d.aggregator.handler.prototype={get:function(a,b){if(!a)return d.merge(d.merge([],this.source),this.target);d.inArray(a,l)==-1&&d.error("invalid type: "+a);var c=this[a];c||d.error("$.aggregator.handler::add: invalid type: "+a);return typeof b=="number"?c[b]:c},add:function(a,b){var c=this.get(b);d.aggregator.isAggregator(a)||d.error("$.aggregator.handler::add: invalid input: aggregator is not an instance of $.aggregator");
d.inArray(a,c)==-1&&c.push(a);return this},remove:function(a,b){var c=this;d.each(b?[b]:l,function(e,f){for(var g=c.get(f),h;(h=d.inArray(a,g))!=-1;)g.splice(h,1)});return c},destroy:function(a){return this._callAggregatorMethod("remove",a,[this.element])},aggregate:function(a){return this._callAggregatorMethod("aggregate",a)},_callAggregatorMethod:function(a,b,c){b=this.get(b||"source");var e=b.length,f;for(c||(c=[]);e--;)(f=b[e])&&f[a].apply(f,c);return this}};d.event.special.aggregate={setup:function(){d.data(this,
"aggregatorHandler",new d.aggregator.handler(this))},add:function(a){if(a=a.data){var b=d.aggregator.get(this);d.aggregator.isHandler(b)&&d.aggregator.isAggregator(a.aggregator)&&b.add(a.aggregator,a.type)}},teardown:function(){var a=d.aggregator.get(this);if(d.aggregator.isHandler(a)){a.destroy();d.removeData(this,"aggregatorHandler")}}};var r={"int":function(a){return u(a,10)},"float":function(a){return p(a)},formatedNumber:function(a){var b=this.options,c=b.dec;a=a?m(a):"";if(a.length>0){c=n[c]||
(n[c]=RegExp("\\"+c,"g"));a=a.replace(c,"").replace(b.sep,".")}if(a.length>0)return p(a);return 0}},s={formatedNumber:function(a){var b=this.options,c=b.dec,e=b.group;a=a?m(a):"";if(a.split)a=a.split(".");else return a;if(a.length>2)return a.join(".");for(e=o[e]||(o[e]=RegExp("(\\d+)(\\d{"+e+"})"));c!=""&&e.test(a[0]);)a[0]=a[0].replace(e,"$1"+c+"$2");return a[0]+(a.length>1&&a[1]!=""?b.sep+a[1]:"")}},q={sum:function(){for(var a=this[0],b=1,c=this.length;b<c;b++)a+=this[b];return a},multiply:function(){for(var a=
this[0],b=1,c=this.length;b<c;b++)a*=this[b];return a},divide:function(){for(var a=this[0],b=1,c=this.length;b<c;b++)a/=this[b];return a},sub:function(){for(var a=this[0],b=1,c=this.length;b<c;b++)a-=this[b];return a}},w={parser:r,method:q}})(jQuery,window);
